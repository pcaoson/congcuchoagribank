<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Tài Chính Chuyên Nghiệp - Agribank</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- External Libraries for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Custom styles and new theme -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #6D071A, #4C0013);
            color: #f0f0f0;
            position: relative; /* Needed for the pseudo-element */
        }

        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            width: 60vw;
            height: 60vh;
            background-image: url('http://googleusercontent.com/file_content/1');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: contain;
            opacity: 0.03;
            transform: translate(-50%, -50%);
            z-index: -1;
        }

        /* --- Animations --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        /* --- General Styles --- */
        .header-glass {
            background: rgba(76, 0, 19, 0.25);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .main-card {
            background: rgba(50, 10, 15, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .tab-menu {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.75rem;
            padding: 0.25rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto; /* For smaller screens */
        }
        .tab-button {
            flex: 1;
            padding: 0.75rem 0.5rem; /* Adjusted padding */
            border-radius: 0.5rem;
            font-weight: 600;
            color: #a0aec0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            white-space: nowrap; /* Prevent wrapping */
            font-size: 0.875rem; /* Smaller font for more tabs */
        }
        .tab-button.active {
            color: #111111;
            background: linear-gradient(145deg, #FDB813, #E6A100);
            box-shadow: 0 4px 15px rgba(253, 184, 19, 0.3);
        }
        .tab-button:not(.active):hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }
        .form-input, .form-select {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f0f0f0;
            transition: all 0.3s ease;
        }
        .form-input::placeholder { color: #a0aec0; }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #FDB813;
            box-shadow: 0 0 0 3px rgba(253, 184, 19, 0.4);
            background: rgba(0, 0, 0, 0.4);
        }
        /* Style for date input text color */
        .form-input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .form-input[type="date"]:valid {
            color: #f0f0f0;
        }
        .form-input[type="date"] {
            color: #a0aec0;
        }
        .shiny-button {
            background: linear-gradient(145deg, #FDB813, #E6A100);
            color: #111111;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(253, 184, 19, 0.3);
        }
        .shiny-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(253, 184, 19, 0.4);
        }
        .secondary-button {
            background: linear-gradient(145deg, #831843, #500724);
            color: #fde2e4;
        }
        .secondary-button:hover {
            box-shadow: 0 6px 25px rgba(131, 24, 67, 0.4);
        }
        .result-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease-in-out;
        }
        .summary-box {
            background: linear-gradient(160deg, rgba(253, 184, 19, 0.1), rgba(230, 161, 0, 0.15));
            border: 1px solid rgba(253, 184, 19, 0.5);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .section-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* --- Clock & Calendar Styles --- */
        .time-segment { background-color: rgba(0,0,0,0.4); padding: 0.5rem 1rem; border-radius: 0.5rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);}
        .time-digit { font-size: 2rem; font-weight: 700; line-height: 1; font-family: 'Courier New', Courier, monospace; color: #f0f0f0; text-shadow: 0 0 5px #FDB813, 0 0 10px #FDB813;}
        .time-separator { font-size: 2rem; font-weight: 700; animation: blink 1s step-end infinite; color: #f0f0f0;}
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body class="antialiased">

    <header class="header-glass text-white p-4 shadow-md sticky top-0 z-10">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <img src="https://www.agribank.com.vn/themes/agribank/images/logo-agribank-2014.png" alt="Agribank Logo" class="h-8 mr-3" onerror="this.style.display='none'">
                <h1 class="text-xl font-semibold tracking-wide">Công Cụ Tài Chính Agribank</h1>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6">
        <!-- Dashboard Section -->
        <section id="dashboard" class="mb-6 fade-in-up">
            <div class="flex justify-center">
                <div id="live-clock" class="w-full max-w-md p-3 bg-black/40 rounded-lg shadow-inner text-white">
                    <div class="flex justify-center items-center gap-2">
                        <div class="time-segment"><span id="hours" class="time-digit">00</span></div>
                        <span class="time-separator">:</span>
                        <div class="time-segment"><span id="minutes" class="time-digit">00</span></div>
                        <span class="time-separator">:</span>
                        <div class="time-segment"><span id="seconds" class="time-digit">00</span></div>
                    </div>
                    <div id="current-date" class="text-sm text-center text-gray-300 mt-2"></div>
                    <div id="lunar-date" class="text-sm text-center text-yellow-400 font-medium mt-1"></div>
                </div>
            </div>
        </section>

        <div id="main-content-card" class="main-card rounded-2xl shadow-lg overflow-hidden max-w-4xl mx-auto opacity-0" style="animation-delay: 0.2s;">
            <div class="p-6 text-center border-b border-white/10">
                <img src="https://www.agribank.com.vn/themes/agribank/images/logo-agribank-2014.png" alt="Agribank Logo" class="h-12 mx-auto" onerror="this.style.display='none'">
            </div>
            <div class="p-4">
                <div class="tab-menu mx-auto">
                    <button id="tab-daily-loan" onclick="switchTab('daily-loan')" class="tab-button active">Tính Lãi Món Vay</button>
                    <button id="tab-loan-schedule" onclick="switchTab('loan-schedule')" class="tab-button">Lịch Trả Nợ</button>
                    <button id="tab-loan-comparison" onclick="switchTab('loan-comparison')" class="tab-button">So Sánh Gói Vay</button>
                    <button id="tab-deposit" onclick="switchTab('deposit')" class="tab-button">Tính Lãi Tiền Gửi</button>
                </div>
            </div>

            <div class="p-6 pt-2">
                <!-- Daily Loan Panel -->
                <div id="panel-daily-loan">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4 text-center">TÍNH LÃI VAY THEO NGÀY</h3>
                    <form id="daily-loan-form" onsubmit="event.preventDefault(); calculateDailyLoan();" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="dailyLoanAmount" class="block text-sm font-medium text-gray-300 mb-1">Số tiền vay (VNĐ)</label>
                                <input type="text" id="dailyLoanAmount" class="form-input w-full px-4 py-2 rounded-lg" required>
                            </div>
                            <div>
                                <label for="standardInterestRate" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất trong hạn (%/năm)</label>
                                <input type="number" step="0.1" id="standardInterestRate" class="form-input w-full px-4 py-2 rounded-lg" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <div>
                                <label for="disbursementDate" class="block text-sm font-medium text-gray-300 mb-1">Ngày giải ngân</label>
                                <input type="date" id="disbursementDate" class="form-input w-full px-4 py-2 rounded-lg" required>
                            </div>
                            <div>
                                <label for="dueDate" class="block text-sm font-medium text-gray-300 mb-1">Ngày đến hạn</label>
                                <input type="date" id="dueDate" class="form-input w-full px-4 py-2 rounded-lg" required>
                            </div>
                            <div>
                                <label for="settlementDate" class="block text-sm font-medium text-gray-300 mb-1">Ngày tất toán</label>
                                <input type="date" id="settlementDate" class="form-input w-full px-4 py-2 rounded-lg" required>
                            </div>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Lãi suất quá hạn (Tự động tính 150%)</label>
                            <div id="calculatedOverdueRate" class="form-input w-full px-4 py-2 rounded-lg bg-black/40">...%/năm</div>
                        </div>
                        <div class="pt-2"><button type="submit" class="w-full shiny-button font-bold py-3 px-4 rounded-lg">Tính Lãi</button></div>
                    </form>
                    <div id="daily-loan-result" class="mt-6 hidden"></div>
                </div>

                <!-- Loan Schedule Panel -->
                <div id="panel-loan-schedule" class="hidden">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4 text-center">LẬP LỊCH TRẢ NỢ CHI TIẾT</h3>
                    <form id="schedule-loan-form" onsubmit="event.preventDefault(); calculateLoanSchedule();" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="schedule-loan-amount" class="block text-sm font-medium text-gray-300 mb-1">Số tiền vay (VND)</label>
                                <input type="text" id="schedule-loan-amount" value="300.000.000" class="form-input w-full p-2 rounded-lg" required>
                            </div>
                            <div>
                                <label for="schedule-loan-term" class="block text-sm font-medium text-gray-300 mb-1">Thời hạn vay (tháng)</label>
                                <input type="number" id="schedule-loan-term" value="60" class="form-input w-full p-2 rounded-lg" required>
                            </div>
                            <div>
                                <label for="schedule-fixed-rate" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất cố định (%/năm)</label>
                                <input type="number" step="0.1" id="schedule-fixed-rate" value="6.5" class="form-input w-full p-2 rounded-lg" required>
                            </div>
                            <div>
                                <label for="schedule-fixed-months" class="block text-sm font-medium text-gray-300 mb-1">Số tháng cố định</label>
                                <input type="number" id="schedule-fixed-months" value="12" class="form-input w-full p-2 rounded-lg" required>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label for="schedule-floating-rate" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất thả nổi (%/năm)</label>
                            <input type="number" step="0.1" id="schedule-floating-rate" value="11" class="form-input w-full p-2 rounded-lg" required>
                        </div>
                        <div class="pt-2 flex flex-col sm:flex-row gap-2">
                            <button type="submit" class="w-full shiny-button font-bold py-3 px-4 rounded-lg">Xem Lịch Trả Nợ</button>
                            <button id="export-loan-btn" type="button" class="w-full secondary-button font-bold py-3 px-4 rounded-lg hidden">📊 Xuất Excel</button>
                        </div>
                    </form>
                    <div id="loan-schedule-result-wrapper" class="mt-6 max-h-96 overflow-y-auto hidden">
                        <div id="loan-schedule-result" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- Loan Comparison Panel -->
                <div id="panel-loan-comparison" class="hidden">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4 text-center">SO SÁNH GÓI VAY TRẢ GÓP</h3>
                    <form id="loan-form" onsubmit="event.preventDefault(); calculateLoanComparison();">
                        <!-- Loan inputs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="loanAmount" class="block text-sm font-medium text-gray-300 mb-1">Tổng số tiền vay (VNĐ)</label>
                                <input type="text" id="loanAmount" value="300.000.000" class="form-input w-full px-4 py-2 rounded-lg" required>
                            </div>
                            <div>
                                <label for="loanTerm" class="block text-sm font-medium text-gray-300 mb-1">Tổng thời gian vay (tháng)</label>
                                <input type="number" id="loanTerm" value="60" class="form-input w-full px-4 py-2 rounded-lg" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Agribank -->
                            <div class="border border-gray-700 p-4 rounded-lg bg-black bg-opacity-20">
                                <h3 class="text-lg font-bold text-yellow-400 mb-3">Ngân hàng 1: Agribank</h3>
                                <div class="space-y-4">
                                    <div><label for="agri_prefInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất ưu đãi (%/năm)</label><input type="number" step="0.1" id="agri_prefInterest" value="6.5" class="form-input w-full px-3 py-2 rounded-lg"></div>
                                    <div><label for="agri_prefTerm" class="block text-sm font-medium text-gray-300 mb-1">Thời gian ưu đãi (tháng)</label><input type="number" id="agri_prefTerm" value="12" class="form-input w-full px-3 py-2 rounded-lg"></div>
                                    <div><label for="agri_floatInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất thả nổi (%/năm)</label><input type="number" step="0.1" id="agri_floatInterest" value="11" class="form-input w-full px-3 py-2 rounded-lg" required></div>
                                </div>
                            </div>
                            <!-- Bank B -->
                            <div class="border border-gray-700 p-4 rounded-lg bg-black bg-opacity-20">
                                <h3 class="text-lg font-bold text-gray-300 mb-3">Ngân hàng 2: Ngân hàng B</h3>
                                <div class="space-y-4">
                                    <div><label for="bankb_prefInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất ưu đãi (%/năm)</label><input type="number" step="0.1" id="bankb_prefInterest" value="7.0" class="form-input w-full px-3 py-2 rounded-lg"></div>
                                    <div><label for="bankb_prefTerm" class="block text-sm font-medium text-gray-300 mb-1">Thời gian ưu đãi (tháng)</label><input type="number" id="bankb_prefTerm" value="6" class="form-input w-full px-3 py-2 rounded-lg"></div>
                                    <div><label for="bankb_floatInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất thả nổi (%/năm)</label><input type="number" step="0.1" id="bankb_floatInterest" value="11.5" class="form-input w-full px-3 py-2 rounded-lg" required></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6"><button type="submit" class="w-full shiny-button font-bold py-3 px-4 rounded-lg">So Sánh Ngay</button></div>
                    </form>
                    
                    <div id="loanResult" class="mt-8 hidden">
                        <div id="loanResultCards" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div id="agri_result_card" class="result-card rounded-xl"></div>
                            <div id="bankb_result_card" class="result-card rounded-xl"></div>
                        </div>
                        <div id="comparisonSummary" class="mt-8"></div>
                    </div>
                </div>

                <!-- Deposit Panel -->
                <div id="panel-deposit" class="hidden">
                     <h3 class="text-xl font-bold text-yellow-400 mb-4 text-center">TÍNH LÃI TIỀN GỬI TIẾT KIỆM</h3>
                     <form id="deposit-form" onsubmit="event.preventDefault(); calculateDeposit();">
                        <div class="space-y-4">
                            <div><label for="depositAmount" class="block text-sm font-medium text-gray-300 mb-1">Số tiền gửi (VNĐ)</label><input type="text" id="depositAmount" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 100,000,000" required></div>
                            <div><label for="depositInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất (%/năm)</label><input type="number" step="0.1" id="depositInterest" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 5.5" required></div>
                            <div><label for="depositTerm" class="block text-sm font-medium text-gray-300 mb-1">Kỳ hạn gửi (tháng)</label><input type="number" id="depositTerm" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 12" required></div>
                        </div>
                        <div class="mt-6"><button type="submit" class="w-full shiny-button font-bold py-3 px-4 rounded-lg">Tính Toán Tiền Gửi</button></div>
                    </form>
                    <div id="depositResult" class="mt-6 hidden">
                        <div class="summary-box">
                             <p class="text-lg text-gray-200">Tổng lãi nhận được:</p>
                             <p id="totalInterestEarned" class="text-3xl font-bold text-yellow-300 my-2"></p>
                             <p class="text-lg text-gray-200 mt-4">Tổng tiền khi đáo hạn:</p>
                             <p id="totalAmount" class="text-2xl font-semibold text-gray-100"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // --- Animate on load ---
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dashboard').classList.add('fade-in-up');
            document.getElementById('main-content-card').classList.add('fade-in-up');
            updateClock();
            setInterval(updateClock, 1000);

            // --- Attach event listeners after DOM is loaded ---
            document.getElementById('loanAmount').addEventListener('input', autoFormatCurrency);
            document.getElementById('depositAmount').addEventListener('input', autoFormatCurrency);
            document.getElementById('dailyLoanAmount').addEventListener('input', autoFormatCurrency);
            document.getElementById('schedule-loan-amount').addEventListener('input', autoFormatCurrency);
        });

        // --- Helper Functions ---
        const currencyFormatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        
        function parseCurrency(value) { 
            return Number(String(value).replace(/\D/g, '')); 
        }
        
        function autoFormatCurrency(event) {
            let input = event.target;
            let value = parseCurrency(input.value);
            if (!isNaN(value)) { 
                let cursorPos = input.selectionStart;
                let oldLength = input.value.length;
                input.value = value === 0 ? '' : new Intl.NumberFormat('vi-VN').format(value);
                let newLength = input.value.length;
                if (newLength > oldLength) {
                    cursorPos += (newLength - oldLength);
                }
                input.setSelectionRange(cursorPos, cursorPos);
            } 
            else { 
                if (input.value !== '') {
                    input.value = '';
                }
            }
        }

        // --- UI Logic ---
        function switchTab(tabName) {
            ['daily-loan', 'loan-schedule', 'loan-comparison', 'deposit'].forEach(tab => {
                const tabButton = document.getElementById(`tab-${tab}`);
                const panel = document.getElementById(`panel-${tab}`);
                if (tabButton) tabButton.classList.remove('active');
                if (panel) panel.classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`panel-${tabName}`).classList.remove('hidden');
        }

        // --- Clock & Lunar Calendar Logic ---
        const LunarCalendar = {
            LUNAR_INFO: [0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,0x0c960,0x0d954,0x0d4a0,0xda50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0],
            CAN: ["Canh", "Tân", "Nhâm", "Quý", "Giáp", "Ất", "Bính", "Đinh", "Mậu", "Kỷ"],
            CHI: ["Thân", "Dậu", "Tuất", "Hợi", "Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi"],
            getLunarYearDays: function(lunarYear) { let i, sum = 348; for (i = 0x8000; i > 0x8; i >>= 1) sum += (this.LUNAR_INFO[lunarYear - 1900] & i) ? 1 : 0; return sum + this.getLeapMonthDays(lunarYear); },
            getLeapMonth: function(lunarYear) { return this.LUNAR_INFO[lunarYear - 1900] & 0xf; },
            getLeapMonthDays: function(lunarYear) { if (this.getLeapMonth(lunarYear)) return (this.LUNAR_INFO[lunarYear - 1900] & 0x10000) ? 30 : 29; return 0; },
            getLunarMonthDays: function(lunarYear, lunarMonth) { if ((lunarMonth > 12) || (lunarMonth < 1)) return -1; let leapMonth = this.getLeapMonth(lunarYear); if (leapMonth > 0 && lunarMonth > leapMonth) lunarMonth--; return (this.LUNAR_INFO[lunarYear - 1900] & (0x10000 >> lunarMonth)) ? 30 : 29; },
            convertSolarToLunar: function(solarDay, solarMonth, solarYear) { let solarDate = new Date(solarYear, solarMonth - 1, solarDay); let startDate = new Date(1900, 0, 31); let dayOffset = Math.floor((solarDate - startDate) / (24 * 60 * 60 * 1000)); let lunarYear = 1900; let yearDays = this.getLunarYearDays(lunarYear); while (dayOffset >= yearDays) { dayOffset -= yearDays; lunarYear++; yearDays = this.getLunarYearDays(lunarYear); } let lunarMonth = 1; let leapMonth = this.getLeapMonth(lunarYear); let isLeap = false; for (lunarMonth = 1; lunarMonth < 13 && dayOffset >= 0; lunarMonth++) { let monthDays = this.getLunarMonthDays(lunarYear, lunarMonth); if (leapMonth > 0 && lunarMonth === (leapMonth + 1) && !isLeap) { --lunarMonth; isLeap = true; monthDays = this.getLeapMonthDays(lunarYear); } if (dayOffset < monthDays) break; dayOffset -= monthDays; } let lunarDay = dayOffset + 1; let canYear = this.CAN[lunarYear % 10]; let chiYear = this.CHI[lunarYear % 12]; return { day: lunarDay, month: lunarMonth, year: lunarYear, canChi: `${canYear} ${chiYear}`, isLeap: isLeap && (lunarMonth === leapMonth) }; },
            getLunarDateString: function(solarDay, solarMonth, solarYear) { const lunar = this.convertSolarToLunar(solarDay, solarMonth, solarYear); return `Ngày ${lunar.day} tháng ${lunar.month} năm ${lunar.canChi}`; }
        };

        function updateClock() { 
            const now = new Date();
            document.getElementById('hours').textContent = now.getHours().toString().padStart(2, '0');
            document.getElementById('minutes').textContent = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('seconds').textContent = now.getSeconds().toString().padStart(2, '0');
            const currentDateStr = now.toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); 
            document.getElementById('current-date').textContent = currentDateStr; 
            document.getElementById('lunar-date').textContent = LunarCalendar.getLunarDateString(now.getDate(), now.getMonth() + 1, now.getFullYear()); 
        }

        // --- Calculation Logic ---
        function calculateLoanDetails(principal, totalTerm, prefInterest, prefTerm, floatInterest) {
            if (isNaN(principal) || principal <= 0 || isNaN(totalTerm) || totalTerm <= 0 || isNaN(prefInterest) || prefInterest < 0 || isNaN(prefTerm) || prefTerm < 0 || isNaN(floatInterest) || floatInterest < 0) {
                return null;
            }
            let totalInterest = 0;
            let remainingBalance = principal;
            const principalPerMonth = principal / totalTerm;

            for (let i = 1; i <= totalTerm; i++) {
                const currentRate = (i <= prefTerm) ? (prefInterest / 12) : (floatInterest / 12);
                const interestPayment = remainingBalance * currentRate;
                totalInterest += interestPayment;
                remainingBalance -= principalPerMonth;
            }
            return {
                totalInterest: totalInterest,
                totalPayment: principal + totalInterest,
                monthlyPayment: (principal + totalInterest) / totalTerm
            };
        }

        function calculateLoanComparison() {
            const principal = parseCurrency(document.getElementById('loanAmount').value);
            const totalTerm = parseInt(document.getElementById('loanTerm').value);
            const agri_prefInterest = parseFloat(document.getElementById('agri_prefInterest').value) / 100;
            const agri_prefTerm = parseInt(document.getElementById('agri_prefTerm').value);
            const agri_floatInterest = parseFloat(document.getElementById('agri_floatInterest').value) / 100;
            const bankb_prefInterest = parseFloat(document.getElementById('bankb_prefInterest').value) / 100;
            const bankb_prefTerm = parseInt(document.getElementById('bankb_prefTerm').value);
            const bankb_floatInterest = parseFloat(document.getElementById('bankb_floatInterest').value) / 100;

            const agri_results = calculateLoanDetails(principal, totalTerm, agri_prefInterest, agri_prefTerm, agri_floatInterest);
            const bankb_results = calculateLoanDetails(principal, totalTerm, bankb_prefInterest, bankb_prefTerm, bankb_floatInterest);

            displayComparisonResults(agri_results, bankb_results);
        }

        function displayComparisonResults(agri, bankb) {
            const agriCard = document.getElementById('agri_result_card');
            const bankbCard = document.getElementById('bankb_result_card');
            const summaryContainer = document.getElementById('comparisonSummary');
            
            if (!agri || !bankb) {
                summaryContainer.innerHTML = `<div class="summary-box"><p class="text-red-400">Lỗi: Vui lòng kiểm tra lại thông tin đã nhập.</p></div>`;
                document.getElementById('loanResult').classList.remove('hidden');
                return;
            }

            agriCard.classList.remove('best-deal');
            bankbCard.classList.remove('best-deal');
            
            let winnerBankName, interestDifference;
            if (agri.totalInterest <= bankb.totalInterest) {
                agriCard.classList.add('best-deal');
                winnerBankName = 'Agribank';
                interestDifference = bankb.totalInterest - agri.totalInterest;
            } else {
                bankbCard.classList.add('best-deal');
                winnerBankName = 'Ngân hàng B';
                interestDifference = agri.totalInterest - bankb.totalInterest;
            }

            agriCard.innerHTML = generateResultCardHTML('Agribank', agri, '#FDB813');
            bankbCard.innerHTML = generateResultCardHTML('Ngân hàng B', bankb, '#d1d5db');
            
            summaryContainer.innerHTML = `
                <div class="summary-box fade-in-up" style="animation-delay: 0.2s;">
                    <h4 class="text-xl font-bold text-gray-100">Kết Luận & Lời Khuyên</h4>
                    <p class="mt-2 text-lg text-gray-200">
                        Lựa chọn <strong class="text-yellow-400">${winnerBankName}</strong> sẽ có lợi hơn, giúp khách hàng tiết kiệm được khoảng:
                    </p>
                    <p class="my-3 text-3xl font-bold text-yellow-300">${currencyFormatter.format(interestDifference)}</p>
                    <p class="text-sm text-gray-400 italic">
                        <strong>Lời khuyên:</strong> Dựa trên tổng lãi, phương án của ${winnerBankName} đang tốt hơn.
                    </p>
                </div>`;

            document.getElementById('loanResult').classList.remove('hidden');
        }

        function generateResultCardHTML(bankName, results, titleColor) {
            return `
                <h4 class="text-lg font-bold mb-3" style="color:${titleColor};">${bankName}</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center bg-black bg-opacity-20 p-2 rounded-md"><span class="font-medium text-gray-400">Trả hàng tháng (TB):</span><span class="font-semibold text-gray-100">${currencyFormatter.format(results.monthlyPayment)}</span></div>
                    <div class="flex justify-between items-center bg-black bg-opacity-20 p-2 rounded-md mt-4"><span class="font-medium text-red-400">Tổng lãi phải trả:</span><span class="font-bold text-red-300">${currencyFormatter.format(results.totalInterest)}</span></div>
                    <div class="flex justify-between items-center bg-black bg-opacity-20 p-2 rounded-md"><span class="font-medium text-gray-400">Tổng cộng phải trả:</span><span class="font-bold text-gray-100">${currencyFormatter.format(results.totalPayment)}</span></div>
                </div>`;
        }
        
        function calculateDeposit() {
            const principal = parseCurrency(document.getElementById('depositAmount').value);
            const annualInterestRate = parseFloat(document.getElementById('depositInterest').value);
            const termInMonths = parseInt(document.getElementById('depositTerm').value);
            if (!principal || !annualInterestRate || !termInMonths) {
                alert('Vui lòng nhập đầy đủ thông tin.');
                return;
            }
            const totalInterestEarned = principal * (annualInterestRate / 100) * (termInMonths / 12);
            const totalAmount = principal + totalInterestEarned;
            document.getElementById('totalInterestEarned').textContent = currencyFormatter.format(totalInterestEarned);
            document.getElementById('totalAmount').textContent = currencyFormatter.format(totalAmount);
            document.getElementById('depositResult').classList.remove('hidden');
        }

        document.getElementById('standardInterestRate').addEventListener('input', (e) => {
            const standardRateValue = parseFloat(e.target.value);
            const overdueDisplay = document.getElementById('calculatedOverdueRate');
            if (!isNaN(standardRateValue) && standardRateValue > 0) {
                const calculatedOverdue = (standardRateValue * 1.5).toFixed(2);
                overdueDisplay.textContent = `${calculatedOverdue}%/năm`;
            } else {
                overdueDisplay.textContent = '...%/năm';
            }
        });

        function calculateDailyLoan() {
            const principal = parseCurrency(document.getElementById('dailyLoanAmount').value);
            const standardRatePercent = parseFloat(document.getElementById('standardInterestRate').value);
            const startDate = new Date(document.getElementById('disbursementDate').value);
            const dueDate = new Date(document.getElementById('dueDate').value);
            const endDate = new Date(document.getElementById('settlementDate').value);

            if (!principal || !standardRatePercent || isNaN(startDate.getTime()) || isNaN(dueDate.getTime()) || isNaN(endDate.getTime())) {
                alert("Vui lòng nhập đầy đủ và chính xác tất cả các trường.");
                return;
            }
            
            if (startDate >= endDate) {
                alert("Ngày tất toán phải sau ngày giải ngân.");
                return;
            }
            
            const standardRate = standardRatePercent / 100;
            const overdueRate = standardRate * 1.5;
            const oneDay = 24 * 60 * 60 * 1000;

            let daysInTerm = 0;
            let daysOverdue = 0;

            const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const due = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

            if (end <= due) {
                daysInTerm = Math.round((end - start) / oneDay);
            } else {
                daysInTerm = Math.round((due - start) / oneDay);
                daysOverdue = Math.round((end - due) / oneDay);
            }
            
            daysInTerm = Math.max(0, daysInTerm);
            daysOverdue = Math.max(0, daysOverdue);

            const interestInTerm = principal * (standardRate / 365) * daysInTerm;
            const interestOverdue = principal * (overdueRate / 365) * daysOverdue;
            const totalInterest = interestInTerm + interestOverdue;
            const totalPayment = principal + totalInterest;

            const resultContainer = document.getElementById('daily-loan-result');
            resultContainer.innerHTML = `
                <div class="summary-box">
                    <h4 class="text-xl font-bold text-gray-100 mb-4">Kết Quả Tính Lãi</h4>
                    <div class="text-left space-y-3">
                        <div class="flex justify-between items-center bg-black/20 p-2 rounded-md"><span>Số ngày trong hạn:</span><span class="font-semibold">${daysInTerm} ngày</span></div>
                        <div class="flex justify-between items-center bg-black/20 p-2 rounded-md"><span>Tiền lãi trong hạn:</span><span class="font-semibold">${currencyFormatter.format(interestInTerm)}</span></div>
                        <div class="flex justify-between items-center bg-black/20 p-2 rounded-md"><span>Số ngày quá hạn:</span><span class="font-semibold text-red-400">${daysOverdue} ngày</span></div>
                        <div class="flex justify-between items-center bg-black/20 p-2 rounded-md"><span>Tiền lãi quá hạn:</span><span class="font-semibold text-red-400">${currencyFormatter.format(interestOverdue)}</span></div>
                        <div class="section-divider my-2"></div>
                        <div class="flex justify-between items-center text-lg"><strong>Tổng tiền lãi:</strong><strong class="text-yellow-300">${currencyFormatter.format(totalInterest)}</strong></div>
                        <div class="flex justify-between items-center text-lg"><strong>Tổng gốc và lãi:</strong><strong class="text-yellow-300">${currencyFormatter.format(totalPayment)}</strong></div>
                    </div>
                </div>
            `;
            resultContainer.classList.remove('hidden');
        }

        // --- Loan Schedule Logic ---
        const exportLoanBtn = document.getElementById('export-loan-btn');

        function calculateLoanSchedule() {
            const P = parseCurrency(document.getElementById('schedule-loan-amount').value);
            const N = parseInt(document.getElementById('schedule-loan-term').value);
            const fixedRateYearly = parseFloat(document.getElementById('schedule-fixed-rate').value) / 100;
            const fixedMonths = parseInt(document.getElementById('schedule-fixed-months').value);
            const floatingRateYearly = parseFloat(document.getElementById('schedule-floating-rate').value) / 100;

            if (isNaN(P) || P <= 0 || isNaN(N) || N <= 0 || isNaN(fixedRateYearly) || isNaN(fixedMonths) || isNaN(floatingRateYearly)) {
                alert('Vui lòng nhập đầy đủ và chính xác các thông số.');
                return;
            }
            if (fixedMonths >= N) {
                alert('Số tháng cố định phải nhỏ hơn tổng thời hạn vay.');
                return;
            }
            
            const schedule = [];
            let remainingBalance = P;
            const principalPerMonth = P / N;
            for (let i = 1; i <= N; i++) {
                const openingBalance = remainingBalance;
                const currentRate = (i <= fixedMonths) ? (fixedRateYearly / 12) : (floatingRateYearly / 12);
                const interestPayment = openingBalance * currentRate;
                const totalPayment = principalPerMonth + interestPayment;
                remainingBalance -= principalPerMonth;
                schedule.push({ month: i, openingBalance: openingBalance, principal: principalPerMonth, interest: interestPayment, totalPayment: totalPayment, closingBalance: remainingBalance < 0 ? 0 : remainingBalance });
            }
            renderLoanSchedule(schedule, P);
            exportLoanBtn.classList.remove('hidden');
        }

        function renderLoanSchedule(schedule, principal) {
            const formatter = new Intl.NumberFormat('vi-VN');
            const totalInterest = schedule.reduce((sum, row) => sum + row.interest, 0);
            const totalPayment = principal + totalInterest;
            const resultWrapper = document.getElementById('loan-schedule-result-wrapper');
            const resultEl = document.getElementById('loan-schedule-result');

            let tableHTML = `<h3 class="text-lg font-bold text-center text-yellow-400 mb-4">Lịch Trả Nợ Dự Kiến</h3>
                <table class="min-w-full divide-y divide-white/10">
                <thead class="bg-white/5"><tr>
                    <th class="px-4 py-2 text-center text-xs font-medium text-yellow-300 uppercase tracking-wider">Kỳ</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-yellow-300 uppercase tracking-wider">Gốc trả</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-yellow-300 uppercase tracking-wider">Lãi trả</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-yellow-300 uppercase tracking-wider">Tổng trả</th>
                </tr></thead><tbody class="divide-y divide-white/10">`;
            schedule.forEach(row => {
                tableHTML += `<tr class="hover:bg-white/5">
                    <td class="text-center p-2">${row.month}</td>
                    <td class="text-right p-2">${formatter.format(Math.round(row.principal))}</td>
                    <td class="text-right p-2">${formatter.format(Math.round(row.interest))}</td>
                    <td class="text-right p-2">${formatter.format(Math.round(row.totalPayment))}</td>
                </tr>`;
            });
            tableHTML += `</tbody>
                <tfoot class="bg-white/10 font-bold">
                    <tr>
                        <td class="text-center p-2">Tổng</td>
                        <td class="text-right p-2">${formatter.format(Math.round(principal))}</td>
                        <td class="text-right p-2">${formatter.format(Math.round(totalInterest))}</td>
                        <td class="text-right p-2">${formatter.format(Math.round(totalPayment))}</td>
                    </tr>
                </tfoot>
            </table>`;
            resultEl.innerHTML = tableHTML;
            resultWrapper.classList.remove('hidden');
        }

        exportLoanBtn.addEventListener('click', () => {
            const P = parseCurrency(document.getElementById('schedule-loan-amount').value);
            const N = parseInt(document.getElementById('schedule-loan-term').value);
            const fixedRateYearly = parseFloat(document.getElementById('schedule-fixed-rate').value) / 100;
            const fixedMonths = parseInt(document.getElementById('schedule-fixed-months').value);
            const floatingRateYearly = parseFloat(document.getElementById('schedule-floating-rate').value) / 100;
            
            const schedule = [];
            let remainingBalance = P;
            const principalPerMonth = P / N;
            for (let i = 1; i <= N; i++) {
                const openingBalance = remainingBalance;
                const currentRate = (i <= fixedMonths) ? (fixedRateYearly / 12) : (floatingRateYearly / 12);
                const interestPayment = openingBalance * currentRate;
                const totalPayment = principalPerMonth + interestPayment;
                remainingBalance -= principalPerMonth;
                schedule.push({ month: i, openingBalance: openingBalance, principal: principalPerMonth, interest: interestPayment, totalPayment: totalPayment, closingBalance: remainingBalance < 0 ? 0 : remainingBalance });
            }
            
            const data = schedule.map(row => ({
                "Kỳ": row.month,
                "Dư nợ đầu kỳ (VND)": Math.round(row.openingBalance),
                "Gốc trả (VND)": Math.round(row.principal),
                "Lãi trả (VND)": Math.round(row.interest),
                "Tổng trả (VND)": Math.round(row.totalPayment),
                "Dư nợ cuối kỳ (VND)": Math.round(row.closingBalance)
            }));

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "LichTraNo");
            XLSX.writeFile(workbook, "LichTraNo_Agribank.xlsx");
        });

    </script>
</body>
</html>
