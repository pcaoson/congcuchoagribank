<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Tài Chính Chuyên Nghiệp - Agribank</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom styles and new theme -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #6D071A, #4C0013);
            color: #f0f0f0;
        }

        /* --- Animations --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        /* --- General Styles --- */
        .header-glass {
            background: rgba(76, 0, 19, 0.25);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .main-card {
            background: rgba(50, 10, 15, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .tab-menu {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.75rem;
            padding: 0.25rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tab-button {
            flex: 1;
            padding: 0.75rem 0;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #a0aec0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
        }
        .tab-button.active {
            color: #111111;
            background: linear-gradient(145deg, #FDB813, #E6A100);
            box-shadow: 0 4px 15px rgba(253, 184, 19, 0.3);
        }
        .tab-button:not(.active):hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
        }
        .form-input, .form-select {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f0f0f0;
            transition: all 0.3s ease;
        }
        .form-input::placeholder { color: #a0aec0; }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #FDB813;
            box-shadow: 0 0 0 3px rgba(253, 184, 19, 0.4);
            background: rgba(0, 0, 0, 0.4);
        }
        .shiny-button {
            background: linear-gradient(145deg, #FDB813, #E6A100);
            color: #111111;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(253, 184, 19, 0.3);
        }
        .shiny-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(253, 184, 19, 0.4);
        }
        .result-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease-in-out;
        }
        .result-card.best-deal {
            border-color: #FDB813;
            box-shadow: 0 0 25px rgba(253, 184, 19, 0.4);
            transform: translateY(-5px) scale(1.02);
            position: relative;
        }
        .best-deal-badge {
            position: absolute;
            top: -12px;
            right: 12px;
            background: linear-gradient(145deg, #FDB813, #E6A100);
            color: #111111;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .summary-box {
            background: linear-gradient(160deg, rgba(253, 184, 19, 0.1), rgba(230, 161, 0, 0.15));
            border: 1px solid rgba(253, 184, 19, 0.5);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .section-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* --- NEW: Clock & Calendar Styles --- */
        .time-segment { background-color: rgba(0,0,0,0.4); padding: 0.5rem 1rem; border-radius: 0.5rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);}
        .time-digit { font-size: 2rem; font-weight: 700; line-height: 1; font-family: 'Courier New', Courier, monospace; color: #f0f0f0; text-shadow: 0 0 5px #FDB813, 0 0 10px #FDB813;}
        .time-separator { font-size: 2rem; font-weight: 700; animation: blink 1s step-end infinite; color: #f0f0f0;}
        @keyframes blink { 50% { opacity: 0; } }

        #weekly-calendar {
            background-color: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.75rem; padding: 1rem; color: #fff;
        }
        #calendar-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;
        }
        #calendar-header button {
            background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 9999px;
            width: 2.5rem; height: 2.5rem; font-size: 1.5rem; transition: background-color 0.2s;
        }
        #calendar-header button:hover { background-color: rgba(255,255,255,0.1); }
        #week-display { font-size: 1.25rem; font-weight: bold; }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; text-align: center; }
        #calendar-grid .weekday { font-weight: bold; color: #FDB813; font-size: 0.875rem; padding-bottom: 0.5rem;}
        #calendar-grid .day {
            padding: 0.75rem 0; border-radius: 50%; cursor: pointer; transition: background-color 0.2s, border 0.2s;
            border: 2px solid transparent;
        }
        #calendar-grid .day:not(.empty):hover { background-color: rgba(255,255,255,0.1); }
        #calendar-grid .day.today {
            background-color: #FDB813; color: #000 !important; font-weight: bold;
        }
        #calendar-grid .day.weekend {
            color: #fca5a5; /* Light Red */
        }
    </style>
</head>
<body class="antialiased">

    <header class="header-glass text-white p-4 shadow-md sticky top-0 z-10">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <img src="https://www.agribank.com.vn/themes/agribank/images/logo-agribank-2014.png" alt="Agribank Logo" class="h-8 mr-3" onerror="this.style.display='none'">
                <h1 class="text-xl font-semibold tracking-wide">Công Cụ Tài Chính Agribank</h1>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6">
        <!-- NEW: Dashboard Section -->
        <section id="dashboard" class="mb-6 fade-in-up">
            <div class="flex flex-col lg:flex-row gap-6 items-start">
                <div id="live-clock" class="w-full lg:w-auto p-3 bg-black/40 rounded-lg shadow-inner text-white">
                    <div class="flex justify-center items-center gap-2">
                        <div class="time-segment"><span id="hours" class="time-digit">00</span></div>
                        <span class="time-separator">:</span>
                        <div class="time-segment"><span id="minutes" class="time-digit">00</span></div>
                        <span class="time-separator">:</span>
                        <div class="time-segment"><span id="seconds" class="time-digit">00</span></div>
                    </div>
                    <div id="current-date" class="text-sm text-center text-gray-300 mt-2"></div>
                    <div id="lunar-date" class="text-sm text-center text-yellow-400 font-medium mt-1"></div>
                </div>
                <div id="weekly-calendar" class="shadow-lg flex-grow w-full">
                    <div id="calendar-header">
                        <button id="prev-week-btn">‹</button>
                        <h2 id="week-display"></h2>
                        <button id="next-week-btn">›</button>
                    </div>
                    <div id="calendar-grid"></div>
                </div>
            </div>
        </section>

        <div id="main-content-card" class="main-card rounded-2xl shadow-lg overflow-hidden max-w-4xl mx-auto opacity-0" style="animation-delay: 0.2s;">
            <div class="p-4">
                <div class="tab-menu mx-auto">
                    <button id="tab-loan" onclick="switchTab('loan')" class="tab-button active">So Sánh Lãi Vay</button>
                    <button id="tab-deposit" onclick="switchTab('deposit')" class="tab-button">Tính Lãi Tiền Gửi</button>
                </div>
            </div>

            <div class="p-6 pt-2">
                <!-- Loan Panel -->
                <div id="panel-loan">
                    <form id="loan-form" onsubmit="event.preventDefault(); calculateLoanComparison();">
                        <!-- Loan inputs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="loanAmount" class="block text-sm font-medium text-gray-300 mb-1">Tổng số tiền vay (VNĐ)</label>
                                <input type="text" id="loanAmount" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 1,000,000,000" required>
                            </div>
                            <div>
                                <label for="loanTerm" class="block text-sm font-medium text-gray-300 mb-1">Tổng thời gian vay (tháng)</label>
                                <input type="number" id="loanTerm" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 240" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Agribank -->
                            <div class="border border-gray-700 p-4 rounded-lg bg-black bg-opacity-20">
                                <h3 class="text-lg font-bold text-yellow-400 mb-3">Ngân hàng 1: Agribank</h3>
                                <div class="space-y-4">
                                    <div><label for="agri_prefInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất ưu đãi (%/năm)</label><input type="number" step="0.1" id="agri_prefInterest" class="form-input w-full px-3 py-2 rounded-lg" placeholder="VD: 7.5"></div>
                                    <div><label for="agri_prefTerm" class="block text-sm font-medium text-gray-300 mb-1">Thời gian ưu đãi (tháng)</label><input type="number" id="agri_prefTerm" class="form-input w-full px-3 py-2 rounded-lg" placeholder="VD: 12"></div>
                                    <div><label for="agri_floatInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất thả nổi (%/năm)</label><input type="number" step="0.1" id="agri_floatInterest" class="form-input w-full px-3 py-2 rounded-lg" placeholder="VD: 10.5" required></div>
                                </div>
                            </div>
                            <!-- Bank B -->
                            <div class="border border-gray-700 p-4 rounded-lg bg-black bg-opacity-20">
                                <h3 class="text-lg font-bold text-gray-300 mb-3">Ngân hàng 2: Ngân hàng B</h3>
                                <div class="space-y-4">
                                    <div><label for="bankb_prefInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất ưu đãi (%/năm)</label><input type="number" step="0.1" id="bankb_prefInterest" class="form-input w-full px-3 py-2 rounded-lg" placeholder="VD: 7.0"></div>
                                    <div><label for="bankb_prefTerm" class="block text-sm font-medium text-gray-300 mb-1">Thời gian ưu đãi (tháng)</label><input type="number" id="bankb_prefTerm" class="form-input w-full px-3 py-2 rounded-lg" placeholder="VD: 6"></div>
                                    <div><label for="bankb_floatInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất thả nổi (%/năm)</label><input type="number" step="0.1" id="bankb_floatInterest" class="form-input w-full px-3 py-2 rounded-lg" placeholder="VD: 11.0" required></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6"><button type="submit" class="w-full shiny-button font-bold py-3 px-4 rounded-lg">So Sánh Ngay</button></div>
                    </form>
                    
                    <div id="loanResult" class="mt-8 hidden">
                        <!-- Comparison results -->
                        <h3 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-2 mb-4">Kết Quả So Sánh</h3>
                        <div id="loanResultCards" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div id="agri_result_card" class="result-card rounded-xl"></div>
                            <div id="bankb_result_card" class="result-card rounded-xl"></div>
                        </div>
                        <div id="comparisonSummary" class="mt-8"></div>
                        
                        <!-- Early Repayment Section -->
                        <div id="prepaymentSection" class="mt-8 pt-6 section-divider">
                            <h3 class="text-xl font-semibold text-gray-100 mb-4">Tính Phí Trả Nợ Trước Hạn</h3>
                            <form id="prepayment-form" onsubmit="event.preventDefault(); calculatePrepaymentFee();" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                                <div>
                                    <label for="prepaymentMonths" class="block text-sm font-medium text-gray-300 mb-1">Trả sau (tháng)</label>
                                    <input type="number" id="prepaymentMonths" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 36" required>
                                </div>
                                <div>
                                    <label for="prepaymentFee" class="block text-sm font-medium text-gray-300 mb-1">Phí trả trước hạn (%)</label>
                                    <input type="number" step="0.1" id="prepaymentFee" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 2" required>
                                </div>
                                <button type="submit" class="w-full shiny-button font-bold py-2 px-4 rounded-lg h-11">Tính Phí</button>
                            </form>
                            <div id="prepaymentResult" class="mt-4 summary-box hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Deposit Panel -->
                <div id="panel-deposit" class="hidden">
                     <form id="deposit-form" onsubmit="event.preventDefault(); calculateDeposit();">
                        <div class="space-y-4">
                            <div><label for="depositAmount" class="block text-sm font-medium text-gray-300 mb-1">Số tiền gửi (VNĐ)</label><input type="text" id="depositAmount" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 100,000,000" required></div>
                            <div><label for="depositInterest" class="block text-sm font-medium text-gray-300 mb-1">Lãi suất (%/năm)</label><input type="number" step="0.1" id="depositInterest" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 5.5" required></div>
                            <div><label for="depositTerm" class="block text-sm font-medium text-gray-300 mb-1">Kỳ hạn gửi (tháng)</label><input type="number" id="depositTerm" class="form-input w-full px-4 py-2 rounded-lg" placeholder="VD: 12" required></div>
                        </div>
                        <div class="mt-6"><button type="submit" class="w-full shiny-button font-bold py-3 px-4 rounded-lg">Tính Toán Tiền Gửi</button></div>
                    </form>
                    <div id="depositResult" class="mt-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-100 border-b border-gray-700 pb-2 mb-3">Kết Quả Ước Tính</h3>
                        <div class="space-y-2 text-gray-200">
                             <div class="flex justify-between items-center bg-black bg-opacity-20 p-3 rounded-lg"><span class="font-medium">Tổng lãi nhận được:</span><span id="totalInterestEarned" class="font-bold text-lg text-green-400"></span></div>
                             <div class="flex justify-between items-center bg-black bg-opacity-20 p-3 rounded-lg"><span class="font-medium">Tổng tiền khi đáo hạn:</span><span id="totalAmount" class="font-semibold text-gray-100"></span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Animate on load ---
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dashboard').classList.add('fade-in-up');
            document.getElementById('main-content-card').classList.add('fade-in-up');
            updateClock();
            setInterval(updateClock, 1000);
            renderWeeklyCalendar();
        });

        // --- Helper Functions ---
        const currencyFormatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        function parseCurrency(value) { return Number(String(value).replace(/[^0-9\.]/g, '')); }
        function autoFormatCurrency(event) {
            let input = event.target;
            let value = parseCurrency(input.value);
            if (!isNaN(value) && value > 0) { 
                let cursorPos = input.selectionStart;
                let oldLength = input.value.length;
                input.value = new Intl.NumberFormat('vi-VN').format(value);
                let newLength = input.value.length;
                cursorPos += (newLength - oldLength);
                input.setSelectionRange(cursorPos, cursorPos);
            } 
            else { input.value = ''; }
        }

        // --- UI Logic ---
        document.getElementById('loanAmount').addEventListener('input', autoFormatCurrency);
        document.getElementById('depositAmount').addEventListener('input', autoFormatCurrency);

        function switchTab(tabName) {
            ['loan', 'deposit'].forEach(tab => {
                document.getElementById(`tab-${tab}`).classList.remove('active');
                document.getElementById(`panel-${tab}`).classList.add('hidden');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`panel-${tabName}`).classList.remove('hidden');
        }

        // --- NEW: Clock, Lunar and Weekly Calendar Logic ---
        const LunarCalendar = {
            LUNAR_INFO: [0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,0x0c960,0x0d954,0x0d4a0,0xda50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0],
            CAN: ["Canh", "Tân", "Nhâm", "Quý", "Giáp", "Ất", "Bính", "Đinh", "Mậu", "Kỷ"],
            CHI: ["Thân", "Dậu", "Tuất", "Hợi", "Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi"],
            getLunarYearDays: function(lunarYear) { let i, sum = 348; for (i = 0x8000; i > 0x8; i >>= 1) sum += (this.LUNAR_INFO[lunarYear - 1900] & i) ? 1 : 0; return sum + this.getLeapMonthDays(lunarYear); },
            getLeapMonth: function(lunarYear) { return this.LUNAR_INFO[lunarYear - 1900] & 0xf; },
            getLeapMonthDays: function(lunarYear) { if (this.getLeapMonth(lunarYear)) return (this.LUNAR_INFO[lunarYear - 1900] & 0x10000) ? 30 : 29; return 0; },
            getLunarMonthDays: function(lunarYear, lunarMonth) { if ((lunarMonth > 12) || (lunarMonth < 1)) return -1; let leapMonth = this.getLeapMonth(lunarYear); if (leapMonth > 0 && lunarMonth > leapMonth) lunarMonth--; return (this.LUNAR_INFO[lunarYear - 1900] & (0x10000 >> lunarMonth)) ? 30 : 29; },
            convertSolarToLunar: function(solarDay, solarMonth, solarYear) { let solarDate = new Date(solarYear, solarMonth - 1, solarDay); let startDate = new Date(1900, 0, 31); let dayOffset = Math.floor((solarDate - startDate) / (24 * 60 * 60 * 1000)); let lunarYear = 1900; let yearDays = this.getLunarYearDays(lunarYear); while (dayOffset >= yearDays) { dayOffset -= yearDays; lunarYear++; yearDays = this.getLunarYearDays(lunarYear); } let lunarMonth = 1; let leapMonth = this.getLeapMonth(lunarYear); let isLeap = false; for (lunarMonth = 1; lunarMonth < 13 && dayOffset >= 0; lunarMonth++) { let monthDays = this.getLunarMonthDays(lunarYear, lunarMonth); if (leapMonth > 0 && lunarMonth === (leapMonth + 1) && !isLeap) { --lunarMonth; isLeap = true; monthDays = this.getLeapMonthDays(lunarYear); } if (dayOffset < monthDays) break; dayOffset -= monthDays; } let lunarDay = dayOffset + 1; let canYear = this.CAN[lunarYear % 10]; let chiYear = this.CHI[lunarYear % 12]; return { day: lunarDay, month: lunarMonth, year: lunarYear, canChi: `${canYear} ${chiYear}`, isLeap: isLeap && (lunarMonth === leapMonth) }; },
            getLunarDateString: function(solarDay, solarMonth, solarYear) { const lunar = this.convertSolarToLunar(solarDay, solarMonth, solarYear); return `Ngày ${lunar.day} tháng ${lunar.month} năm ${lunar.canChi}`; }
        };

        function updateClock() { 
            const now = new Date();
            document.getElementById('hours').textContent = now.getHours().toString().padStart(2, '0');
            document.getElementById('minutes').textContent = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('seconds').textContent = now.getSeconds().toString().padStart(2, '0');
            const currentDateStr = now.toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); 
            document.getElementById('current-date').textContent = currentDateStr; 
            document.getElementById('lunar-date').textContent = LunarCalendar.getLunarDateString(now.getDate(), now.getMonth() + 1, now.getFullYear()); 
        }

        const calendarGrid = document.getElementById('calendar-grid');
        const weekDisplay = document.getElementById('week-display');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        let calendarCurrentDate = new Date();

        function renderWeeklyCalendar() {
            calendarGrid.innerHTML = ''; 

            const currentDayOfWeek = calendarCurrentDate.getDay();
            const startOfWeek = new Date(calendarCurrentDate);
            const dayOffset = (currentDayOfWeek === 0) ? -6 : 1 - currentDayOfWeek;
            startOfWeek.setDate(calendarCurrentDate.getDate() + dayOffset);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            const formatter = new Intl.DateTimeFormat('vi-VN', { day: '2-digit', month: '2-digit' });
            weekDisplay.textContent = `Tuần: ${formatter.format(startOfWeek)} - ${formatter.format(endOfWeek)}`;

            const weekdays = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
            weekdays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'weekday';
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);

                const dayCell = document.createElement('div');
                dayCell.className = 'day';
                dayCell.textContent = dayDate.getDate();
                
                const today = new Date();
                if (dayDate.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }

                const dayOfWeek = dayDate.getDay();
                if (dayOfWeek === 6 || dayOfWeek === 0) {
                    dayCell.classList.add('weekend');
                }
                calendarGrid.appendChild(dayCell);
            }
        }
        
        prevWeekBtn.addEventListener('click', () => {
            calendarCurrentDate.setDate(calendarCurrentDate.getDate() - 7);
            renderWeeklyCalendar();
        });

        nextWeekBtn.addEventListener('click', () => {
            calendarCurrentDate.setDate(calendarCurrentDate.getDate() + 7);
            renderWeeklyCalendar();
        });

        // --- Calculation Logic ---
        function calculateLoanDetails(principal, totalTerm, prefInterest, prefTerm, floatInterest, stopAfterMonth = 0) {
            if (!prefInterest || !prefTerm || prefTerm <= 0) {
                prefInterest = floatInterest;
                prefTerm = totalTerm;
            }
            const monthlyPrefRate = prefInterest / 100 / 12;
            const monthlyFloatRate = floatInterest / 100 / 12;
            let remainingPrincipal = principal;
            let totalInterestPaid = 0;
            let monthlyPayments = [];
            const annuity = (p, r, n) => (r === 0) ? p / n : p * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
            
            const loopEnd = stopAfterMonth > 0 ? stopAfterMonth : totalTerm;

            for (let month = 1; month <= loopEnd; month++) {
                let currentMonthlyRate = (month <= prefTerm) ? monthlyPrefRate : monthlyFloatRate;
                let remainingTerm = totalTerm - month + 1;
                let monthlyPayment = annuity(remainingPrincipal, currentMonthlyRate, remainingTerm);
                let interestForMonth = remainingPrincipal * currentMonthlyRate;
                let principalForMonth = monthlyPayment - interestForMonth;
                remainingPrincipal -= principalForMonth;
                totalInterestPaid += interestForMonth;
                monthlyPayments.push(monthlyPayment);
            }
            
            if (stopAfterMonth > 0) {
                return { remainingPrincipal: remainingPrincipal };
            }

            return {
                firstMonthlyPayment: monthlyPayments[0] || 0,
                floatMonthlyPayment: monthlyPayments[prefTerm] || monthlyPayments[0] || 0,
                totalInterest: totalInterestPaid,
                totalPayment: principal + totalInterestPaid,
            };
        }

        function calculateLoanComparison() {
            const principal = parseCurrency(document.getElementById('loanAmount').value);
            const totalTerm = parseInt(document.getElementById('loanTerm').value);
            const agri_prefInterest = parseFloat(document.getElementById('agri_prefInterest').value) || 0;
            const agri_prefTerm = parseInt(document.getElementById('agri_prefTerm').value) || 0;
            const agri_floatInterest = parseFloat(document.getElementById('agri_floatInterest').value);
            const bankb_prefInterest = parseFloat(document.getElementById('bankb_prefInterest').value) || 0;
            const bankb_prefTerm = parseInt(document.getElementById('bankb_prefTerm').value) || 0;
            const bankb_floatInterest = parseFloat(document.getElementById('bankb_floatInterest').value);

            if (!principal || !totalTerm || !agri_floatInterest || !bankb_floatInterest) {
                alert('Vui lòng nhập đầy đủ các trường thông tin bắt buộc.');
                return;
            }

            const agri_results = calculateLoanDetails(principal, totalTerm, agri_prefInterest, agri_prefTerm, agri_floatInterest);
            const bankb_results = calculateLoanDetails(principal, totalTerm, bankb_prefInterest, bankb_prefTerm, bankb_floatInterest);

            displayComparisonResults(agri_results, bankb_results);
        }

        function displayComparisonResults(agri, bankb) {
            const agriCard = document.getElementById('agri_result_card');
            const bankbCard = document.getElementById('bankb_result_card');
            const summaryContainer = document.getElementById('comparisonSummary');
            
            agriCard.classList.remove('best-deal');
            bankbCard.classList.remove('best-deal');
            
            let winnerBankName, interestDifference;
            if (agri.totalInterest <= bankb.totalInterest) {
                agriCard.classList.add('best-deal');
                winnerBankName = 'Agribank';
                interestDifference = bankb.totalInterest - agri.totalInterest;
            } else {
                bankbCard.classList.add('best-deal');
                winnerBankName = 'Ngân hàng B';
                interestDifference = agri.totalInterest - bankb.totalInterest;
            }

            agriCard.innerHTML = generateResultCardHTML('Agribank', agri, '#FDB813');
            bankbCard.innerHTML = generateResultCardHTML('Ngân hàng B', bankb, '#d1d5db');
            
            summaryContainer.innerHTML = `
                <div class="summary-box fade-in-up" style="animation-delay: 0.2s;">
                    <h4 class="text-xl font-bold text-gray-100">Kết Luận & Lời Khuyên</h4>
                    <p class="mt-2 text-lg text-gray-200">
                        Lựa chọn <strong class="text-yellow-400">${winnerBankName}</strong> sẽ có lợi hơn, giúp khách hàng tiết kiệm được khoảng:
                    </p>
                    <p class="my-3 text-3xl font-bold text-yellow-300">${currencyFormatter.format(interestDifference)}</p>
                    <p class="text-sm text-gray-400 italic">
                        <strong>Lời khuyên:</strong> Dựa trên tổng lãi, phương án của ${winnerBankName} đang tốt hơn. Cán bộ có thể tư vấn thêm cho khách hàng về các yếu tố khác như phí trả nợ trước hạn.
                    </p>
                </div>`;

            document.getElementById('loanResult').classList.remove('hidden');
        }

        function generateResultCardHTML(bankName, results, titleColor) {
            const isBestDeal = (bankName === 'Agribank' && document.getElementById('agri_result_card').classList.contains('best-deal')) ||
                               (bankName !== 'Agribank' && document.getElementById('bankb_result_card').classList.contains('best-deal'));

            return `
                ${isBestDeal ? '<div class="best-deal-badge">Lựa chọn tốt</div>' : ''}
                <h4 class="text-lg font-bold mb-3" style="color:${titleColor};">${bankName}</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center bg-black bg-opacity-20 p-2 rounded-md"><span class="font-medium text-gray-400">Trả tháng đầu:</span><span class="font-semibold text-gray-100">${currencyFormatter.format(results.firstMonthlyPayment)}</span></div>
                    <div class="flex justify-between items-center bg-black bg-opacity-20 p-2 rounded-md"><span class="font-medium text-gray-400">Trả sau ưu đãi:</span><span class="font-semibold text-gray-100">${currencyFormatter.format(results.floatMonthlyPayment)}</span></div>
                    <div class="flex justify-between items-center bg-black bg-opacity-20 p-2 rounded-md mt-4"><span class="font-medium text-red-400">Tổng lãi phải trả:</span><span class="font-bold text-red-300">${currencyFormatter.format(results.totalInterest)}</span></div>
                    <div class="flex justify-between items-center bg-black bg-opacity-20 p-2 rounded-md"><span class="font-medium text-gray-400">Tổng cộng phải trả:</span><span class="font-bold text-gray-100">${currencyFormatter.format(results.totalPayment)}</span></div>
                </div>`;
        }
        
        function calculatePrepaymentFee() {
            const monthsPaid = parseInt(document.getElementById('prepaymentMonths').value);
            const feePercentage = parseFloat(document.getElementById('prepaymentFee').value);
            
            const isAgriBest = document.getElementById('agri_result_card').classList.contains('best-deal');
            const principal = parseCurrency(document.getElementById('loanAmount').value);
            const totalTerm = parseInt(document.getElementById('loanTerm').value);

            if (!monthsPaid || !feePercentage || monthsPaid >= totalTerm) {
                alert("Vui lòng nhập số tháng đã trả hợp lệ (nhỏ hơn tổng thời gian vay).");
                return;
            }

            const prefInterest = parseFloat(document.getElementById(isAgriBest ? 'agri_prefInterest' : 'bankb_prefInterest').value) || 0;
            const prefTerm = parseInt(document.getElementById(isAgriBest ? 'agri_prefTerm' : 'bankb_prefTerm').value) || 0;
            const floatInterest = parseFloat(document.getElementById(isAgriBest ? 'agri_floatInterest' : 'bankb_floatInterest').value);

            const result = calculateLoanDetails(principal, totalTerm, prefInterest, prefTerm, floatInterest, monthsPaid);
            const remainingPrincipal = result.remainingPrincipal;
            const feeAmount = remainingPrincipal * (feePercentage / 100);

            const resultContainer = document.getElementById('prepaymentResult');
            resultContainer.innerHTML = `
                <p class="text-gray-200">Dư nợ gốc còn lại sau ${monthsPaid} tháng là: <strong class="text-yellow-300">${currencyFormatter.format(remainingPrincipal)}</strong></p>
                <p class="text-gray-200 mt-2">Phí trả nợ trước hạn (${feePercentage}%) là: <strong class="text-yellow-300">${currencyFormatter.format(feeAmount)}</strong></p>
            `;
            resultContainer.classList.remove('hidden');
        }
        
        function calculateDeposit() {
            const principal = parseCurrency(document.getElementById('depositAmount').value);
            const annualInterestRate = parseFloat(document.getElementById('depositInterest').value);
            const termInMonths = parseInt(document.getElementById('depositTerm').value);
            if (!principal || !annualInterestRate || !termInMonths) {
                alert('Vui lòng nhập đầy đủ thông tin.');
                return;
            }
            const totalInterestEarned = principal * (annualInterestRate / 100) * (termInMonths / 12);
            const totalAmount = principal + totalInterestEarned;
            document.getElementById('totalInterestEarned').textContent = currencyFormatter.format(totalInterestEarned);
            document.getElementById('totalAmount').textContent = currencyFormatter.format(totalAmount);
            document.getElementById('depositResult').classList.remove('hidden');
        }

    </script>
</body>
</html>
